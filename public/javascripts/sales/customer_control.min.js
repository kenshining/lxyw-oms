layui.use(["form","layer","element","jquery","table"],function(){var m=layui.jquery,c=(layui.form,layui.layer),r=layui.table;layui.element;m("#add").on("click",function(){var e=c.open({content:"/sales/customer_edit",type:2,anim:2,title:"编辑客户信息",btn:["保存","取消"],success:function(e,t){},yes:function(n,e){var t=c.getChildFrame("#customer_form",n),s=validateSave(t);if(""==s){var l=m.parseJSON(t.contents().find("#cus_table_container").attr("data")),a=c.load(2);m.post("/sales/customer_save",{customerName:t.contents().find("#customer_name").val(),customerType:t.contents().find("#customer_type").val(),customerCellphone:t.contents().find("#customer_cellphone").val(),customerEmail:t.contents().find("#customer_email").val(),customerAddress:t.contents().find("#customer_address").val(),customerRmarks:t.contents().find("#customer_remarks").val(),custlist:JSON.stringify(l)},function(e,t,s){c.close(a),0==e.code?(c.close(n),c.msg("客户信息成功"),r.reload("customer_search_table")):c.msg("保存失败："+e.message)},"json")}else c.msg(s)}});c.full(e)}),r.render({elem:"#table_content",id:"customer_search_table",url:"/sales/customer_findByPage",where:{t:(new Date).getTime(),customerName:m("#cust_search_name").val(),customerCellphone:m("#cust_search_cellphone").val(),customerType:m("#cust_search_type").val()},cols:[[{field:"customerName",align:"center",title:"客户名称"},{field:"customerType",align:"center",title:"客户类别"},{field:"customerCellphone",align:"center",title:"客户电话"},{field:"customerEmail",align:"center",title:"Email"},{field:"customerAddress",align:"center",title:"客户地址"},{fixed:"right",align:"center",title:"操作",toolbar:"#table_control_bar"}]],page:!0,loading:!0,limits:[10,20,50,90]}),m("#search").on("click",function(){r.reload("customer_search_table",{where:{t:(new Date).getTime(),customerName:m("#cust_search_name").val(),customerCellphone:m("#cust_search_cellphone").val(),customerType:m("#cust_search_type").val()}})}),r.on("tool(cust_table_filter)",function(e){var o=e.data,t=e.event;e.tr;if("del"===t)c.confirm("确认要删除客户信息和联系人吗？",{icon:4,title:"删除",btn:["删除","取消"]},function(n){c.close(n);var l=c.load(2);m.post("/sales/customer_delete",{id:o.id,t:(new Date).getTime()},function(e,t,s){c.close(l),0==e.code?(c.close(n),c.msg("客户与联系人数据已删除！"),r.reload("customer_search_table")):c.msg("保存失败："+e.message)},"json")});else if("edit"===t){var s=c.open({content:"/sales/customer_edit?id="+o.id,type:2,anim:2,title:"编辑客户信息",btn:["保存","取消"],success:function(e,t){},yes:function(n,e){var t=c.getChildFrame("form",n),s=i(t);if(""==s){var l=m.parseJSON(t.contents().find("#cus_table_container").attr("data")),a=c.load(2);m.post("/sales/customer_save",{id:o.id,customerName:t.contents().find("#customer_name").val(),customerType:t.contents().find("#customer_type").val(),customerCellphone:t.contents().find("#customer_cellphone").val(),customerEmail:t.contents().find("#customer_email").val(),customerAddress:t.contents().find("#customer_address").val(),customerRmarks:t.contents().find("#customer_remarks").val(),custlist:JSON.stringify(l)},function(e,t,s){c.close(a),0==e.code?(c.close(n),c.msg("客户信息成功"),r.reload("customer_search_table")):c.msg("保存失败："+e.message)},"json")}else c.msg(s)}});c.full(s)}});var i=function(e){var t=m.parseJSON(e.contents().find("#cus_table_container").attr("data")),s=e.contents().find("#customer_name").val(),n=e.contents().find("#customer_type").val(),l=e.contents().find("#customer_cellphone").val(),a=e.contents().find("#customer_email").val(),o=e.contents().find("#customer_address").val(),c=e.contents().find("#customer_remarks").val(),r=new CommonValidationUtils,i=new CommonValidationEmu;return r.isNull(s)||r.isNull(n)||r.isNull(l)||r.isNull(c)||r.isNull(o)||r.isNull(a)?i.errorMsg.all_not_null:t.length<=0?"必须设置一位[采购联系人]":""}});